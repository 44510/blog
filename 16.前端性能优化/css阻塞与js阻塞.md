

# 哪些地方会出现css阻塞，哪些地方会出现js阻塞？

## js的阻塞特性：

**所有浏览器在下载JS的时候，会阻止一切其他活动，比如其他资源的下载，内容的呈现等等**。直到JS下载、解析、执行完毕后才开始继续并行下载其他资源并呈现内容。为了提高用户体验，**新一代浏览器都支持并行下载JS**，但是JS下载仍然会阻塞其它资源的下载（例如.图片，css文件等）。 
**原因：由于浏览器为了防止出现JS修改DOM树，需要重新构建DOM树的情况，所以就会阻塞其他的下载和呈现。** 


嵌入JS会阻塞所有内容的呈现，而外部JS只会阻塞其后内容的显示，2种方式都会阻塞其后资源的下载。也就是说外部样式不会阻塞外部脚本的加载，但会阻塞外部脚本的执行。

## CSS怎么会阻塞加载？

CSS本来是可以并行下载的，在什么情况下会出现阻塞加载了(在测试观察中，IE6下CSS都是阻塞加载） 
当CSS后面跟着嵌入的JS的时候，该CSS就会出现阻塞后面资源下载的情况。而当把嵌入JS放到CSS前面，就不会出现阻塞的情况了。 

根本原因：因为浏览器会维持html中css和js的顺序，**样式表必须在嵌入的JS执行前先加载、解析完**。**而嵌入的JS会阻塞后面的资源加载，所以就会出现上面CSS阻塞下载的情况。**

## JS应该放在什么位置？

(1)、放在底部，虽然放在底部照样会阻塞所有呈现，但不会阻塞资源下载。 
(2)、**如果嵌入JS放在head中，请把嵌入JS放在CSS头部。** 
(3)、使用defer（**只支持IE**） 
(4)、**不要在嵌入的JS中调用运行时间较长的函数，如果一定要用，可以用setTimeout来调用**，延后执行

## Javascript无阻塞加载具体方式

将脚本放在底部。\还是放在head中，用以保证在js加载前，能加载出正常显示的页面。\<script>标签放在\前。 
成组脚本：由于每个\<script>标签下载时阻塞页面解析过程，所以限制页面的\<script>总数也可以改善性能。适用于内联脚本和外部脚本。 
非阻塞脚本：**等页面完成加载后，再加载js代码。也就是，在window.onload事件发出后开始下载代码。** 
（1）defer属性：支持IE4和fierfox3.5更高版本浏览器 
（2）动态脚本元素：文档对象模型（DOM）允许你使用js动态创建HTML的几乎全部文档内容。代码如下：

```
<script>

var script=document.createElement("script");

script.type="text/javascript";

script.src="file.js";

document.getElementsByTagName("head")[0].appendChild(script);

</script>

```

此技术的重点在于：无论在何处启动下载，文件额下载和运行都不会阻塞其他页面处理过程。即使在head里（除了用于下载文件的http链接）。

## css与js阻塞dom解析与渲染

[参考]<https://mp.weixin.qq.com/s/xUUxYs_iFyKg6z4RrtcjVg>

浏览器的策略：尽量减少渲染的次数
本质上来说：css与html都是可以被操作的内容，js就是来操作的内容，必须等到dom Tree与css Tree都生成且稳定的时候才会显示出来，而中间的这段时间就是阻塞的时间。

- `CSS 不会阻塞 DOM 的解析`
- `CSS 阻塞页面渲染`: 所以dom会先解析，等待css树生成之后再渲染，这样就会让css阻塞页面的渲染，主要的问题在于，css文件的下载时间。
- `JS 阻塞 DOM 解析`: 浏览器并不知道脚本的内容是什么，如果先行解析下面的 DOM，万一脚本内全删了后面的 DOM，浏览器就白干活了。更别谈丧心病狂的 document.write。浏览器无法预估里面的内容，那就干脆全部停住，等脚本执行完再干活就好了。
- js同样的原理，如果js会操作dom，那就会改变render树，从而阻止渲染。
- `JS 执行会等待 CSS 下载`
- `JS 阻塞 DOM 解析，但浏览器会"偷看"DOM，预先下载相关资源。`
- `每次碰到<script>标签时，浏览器都会渲染一次页面。`这是基于同样的理由，浏览器不知道脚本的内容，因而碰到脚本时，只好先渲染页面，确保脚本能获取到最新的 DOM 元素信息，尽管脚本可能不需要这些信息。
- `浏览器遇到 <script>且没有 defer 或 async 属性的 标签时，会触发页面渲染`，因而如果前面 CSS 资源尚未加载完毕时，浏览器会等待它加载完毕在执行脚本。

### 优化策略

如果 JS 文件体积太大，同时你确定没必要阻塞 DOM 解析的话，不妨按需要加上 defer 或者 async 属性，此时脚本下载的过程中是不会阻塞 DOM 解析的。
