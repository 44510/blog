---
title: MySql
date: 2020-3-4
tags:
  - SQL
  - MySql
categories:
  - [SQL, MySql]
---

## SQL PRIMARY KEY 约束

- PRIMARY KEY 约束**唯一标识数据库表中的每条记录**。
- 主键必须包含唯一的值。
- 主键列不能包含 NULL 值。
- **每个表都应该有一个主键**，并且每个表只能有一个主键。

## 索引

索引，类似书籍的目录，可以根据目录的**某个页码**立即找到对应的内容。

索引的优点：1. 天生排序。2. 快速查找。
索引的缺点：1. 占用空间。2. 降低更新表的速度。

注意点：`小表使用全表扫描更快，中大表(多大算是中大表)才使用索引。超级大表索引基本无效`。

索引从实现上说，分成 2 种：聚集索引和辅助索引（也叫二级索引或者非聚集索引）

从功能上说，分为 6 种：**普通索引，唯一索引，主键索引，复合索引，外键索引，全文索引**。

- 索引可以加快数据库的**检索速度**；
- 表经常**进行 INSERT/UPDATE/DELETE 操作就不要建立索引了**，换言之：索引会降低插入、删除、修改等维护任务的速度；
- 索引需要**占物理和数据空间**；
- 了解过索引的**最左匹配原则**；
- 知道索引的分类：聚集索引和非聚集索引；
- Mysql 支持 Hash 索引和 B+树索引两种

### 索引做了些什么可以让我们查询加快速度呢

其实就是**将无序的数据变成有序**(相对)，这样就可以使用二分法查找了。

底层结构就是 B+树，B+树作为树的一种实现，能够让我们很快地查找出对应的记录。

#### 关系型数据库和 nosql 查询效率谁高

添加了索引的表，关系型是 B+ tree 查询效率相对较高。

### 索引降低增删改的速度

也就是查找的时候方便，新增与删除的时候就会更麻烦，需要构建平衡树。

B+树是平衡树的一种。

平衡树：**它是一棵空树或它的左右两个子树的高度差的绝对值不超过 1**，并且左右两个子树都是一棵平衡二叉树。时间复杂度就是 O(logn，二分法 log2(n))。

如果一棵普通的树在极端的情况下，是能退化成链表的(树的优点就不复存在了)。

B+树是一颗平衡树，如果我们对这颗树增删改的话，那肯定会破坏它的原有结构。

要维持平衡树，就必须做额外的工作。正因为这些额外的工作开销，导致索引会降低增删改的速度。

除了 B+树之外，还有一种常见的是**哈希索引**。

## sql 的执行

Mysql 的基本存储结构是**页**(记录都存在页里边)。

- 各个数据页可以组成一个双向链表；
- 而每个数据页中的记录又可以组成一个单向链表；
- 每个数据页都会为存储在它里边儿的记录生成一个**页目录**，在通过**主键**查找某条记录的时候可以在页目录中**使用二分法快速定位到对应的槽**，然后再遍历该槽对应分组中的记录即可快速找到指定的记录；
- 以其他列(非主键)作为搜索条件：只能从最小记录开始**依次遍历单链表中的每条记录**。

如果我们写`select * from user where username = 'qiu'`这样没有进行任何优化的 sql 语句，默认会这样做：

1. 定位到记录所在的页;
2. 需要遍历双向链表，**找到所在的页**;
3. 从所在的页内中查找相应的记录;
4. 由于不是根据主键查询，只能遍历所在页的单链表了;
5. 很明显，在数据量很大的情况下这样查找会很慢！

## 锁

即使我们不会这些锁知识，我们的程序在一般情况下还是可以跑得好好的。因为这些锁数据库隐式帮我们加了。

读锁和写锁是互斥的，读写操作是串行。

## mysql format 的格式

format 为转换的格式，包含格式如下：

%M 月名字(January……December)
%W 星期名字(Sunday……Saturday)
%D 有英语前缀的月份的日期(1st, 2nd, 3rd, 等等。）
%Y 年, 数字, 4 位
%y 年, 数字, 2 位
%a 缩写的星期名字(Sun……Sat)
%d 月份中的天数, 数字(00……31)
%e 月份中的天数, 数字(0……31)
%m 月, 数字(01……12)
%c 月, 数字(1……12)
%b 缩写的月份名字(Jan……Dec)
%j 一年中的天数(001……366)
%H 小时(00……23)
%k 小时(0……23)
%h 小时(01……12)
%I 小时(01……12)
%l 小时(1……12)
%i 分钟, 数字(00……59)
%r 时间,12 小时(hh:mm:ss [AP]M)
%T 时间,24 小时(hh:mm:ss)
%S 秒(00……59)
%s 秒(00……59)
%p AM 或 PM
%w 一个星期中的天数(0=Sunday ……6=Saturday ）
%U 星期(0……52), 这里星期天是星期的第一天
%u 星期(0……52), 这里星期一是星期的第一

需要显示年月日（xxxx-xx-xx），这个时候就可以用 date_format(date,'%Y-%m-%d')处理。

## MySQL 数据类型

在 [MySQL](https://www.w3school.com.cn/sql/sql_datatypes.asp) 中，有三种主要的类型：**文本**、**数字**和**日期/时间**类型。

## 类型转换 CAST(xxx AS 类型)

和 SQL Server 一样,就是类型参数有点点不同 : CAST(xxx AS 类型) , CONVERT(xxx,类型)

可用的类型如下：

- 二进制,同带 binary 前缀的效果 : BINARY
- 字符型,可带参数 : CHAR()
- 日期 : DATE
- 时间: TIME
- 日期时间型 : DATETIME
- 浮点数 : DECIMAL
- 整数 : SIGNED
- 无符号整数 : UNSIGNED

## isnull，空值判断

mysql 中：

1.isnull(exper) 判断 exper 是否为空，是则返回 1，否则返回 0

2.ifnull(exper1,exper2)判断 exper1 是否为空，是则用 exper2 代替

3.nullif(exper1,exper2)如果 expr1= expr2 成立，那么返回值为 NULL，否则返回值为 expr1。

## 内连接、左连接（左外连接）、右连接（右外连接）、全连接（全外连接）

[参考文章](https://blog.csdn.net/plg17/article/details/78758593)

### 内链接：inner join on

返回两个表的交集。

### 左外连接：left join on / left outer join on

left join 是 left outer join 的简写，它的全称是左外连接，是外连接中的一种。
左(外)连接，左表(a_table)的记录将会全部表示出来，而右表(b_table)只会显示符合搜索条件的记录。右表记录不足的地方均为 NULL。

### 右连接（右外连接）：right join on / right outer join on

right join 是 right outer join 的简写，它的全称是右外连接，是外连接中的一种。
与左(外)连接相反，右(外)连接，左表(a_table)只会显示符合搜索条件的记录，而右表(b_table)的记录将会全部表示出来。左表记录不足的地方均为 NULL。

### 全连接（全外连接）

MySQL 目前不支持此种方式，可以用其他方式替代解决。

## 数据库事务(Database Transaction)

是指作为单个逻辑工作单元执行的一系列操作，要么完全地执行，要么完全地不执行。事务处理可以确保除非事务性单元内的所有操作都成功完成，否则不会永久更新面向数据的资源。通过将一组相关操作组合为一个要么全部成功要么全部失败的单元，可以简化错误恢复并使应用程序更加可靠。一个逻辑工作单元要成为事务，必须满足所谓的 ACID（原子性、一致性、隔离性和持久性）属性。事务是数据库运行中的逻辑工作单位，由 DBMS 中的事务管理子系统负责事务的处理。

## 优化现有 mysql 数据库

1. 数据库设计和表创建时就要考虑性能；
   1. mysql 数据库本身高度灵活，造成性能不足，严重依赖开发人员能力。也就是说开发人员能力高，则 mysql 性能高。这也是很多关系型数据库的通病，所以公司的 dba 通常工资巨高。
   2. 表设计的时候要注意的地方：
      1. 表字段避免 null 值出现，**null 值很难查询优化且占用额外的索引空间**，**推荐默认数字 0 代替 null**。
      2. 尽量使用 INT 而非 BIGINT，如果非负则加上 UNSIGNED（这样会扩大一倍），当然能使用 TINYINT、SMALLINT、MEDIUM_INT 更好。
      3. 使用枚举或整数代替字符串类型；
      4. 尽量使用 TIMESTAMP 而非 DATETIME；
      5. 单表不要有太多字段，建议在 20 以内；
      6. 用整型来存 IP；
   3. 索引：简言之就是使用合适的数据类型，选择合适的索引
      1. 索引并不是越多越好，要根据查询有针对性的创建，考虑在 WHERE 和 ORDER BY 命令上涉及的列建立索引；
      2. 应尽量**避免在 WHERE 子句中对字段进行 NULL 值判断**，否则将导致引擎放弃使用索引而进行全表扫描；
      3. 值分布很稀少的字段不适合建索引，例如"性别"这种只有两三个值的字段；
      4. 字符字段只建前缀索引；
      5. **字符字段最好不要做主键**；
      6. **不用外键，由程序保证约束**；
      7. 尽量不用 UNIQUE，由程序保证约束；
      8. 用多列索引时主意顺序和查询条件保持一致，同时删除不必要的单列索引；
   4. 选择合适的数据类型：
      1. 使用可存下数据的最小的数据类型，整型 < date,time < char,varchar < blob；
      2. 使用简单的数据类型，整型比字符处理开销更小，因为字符串的比较更复杂。
      3. 使用合理的字段属性长度，固定长度的表会更快，使用 enum、char 而不是 varchar（4）尽可能使用 not null 定义字段；
      4. 尽量少用 text，非用不可最好分表# 选择合适的索引列；
2. sql 的编写需要注意优化；
   1. 使用 limit 对查询结果的记录进行限定；
   2. 避免 select \*，将需要查找的字段列出来；
   3. 使用连接（join）来代替子查询；
   4. 拆分大的 delete 或 insert 语句；
   5. 可通过开启慢查询日志来找出较慢的 SQL<https://kalacloud.com/blog/how-to-use-mysql-slow-query-log-profiling-mysqldumpslow/>；
   6. 不做列运算；
   7. sql 语句尽可能简单：一条 sql 只能在一个 cpu 运算；大语句拆小语句，减少锁时间；一条大 sql 可以堵死整个库；
   8. OR 改写成 IN：OR 的效率是 n 级别，IN 的效率是 log(n)级别，in 的个数建议控制在 200 以内；
   9. 少用 JOIN；
   10. 避免%xxx 式查询；
3. 分区；
4. 分表；
5. 分库。

## 参考

1. [图解 MySql 原理](https://zhuanlan.zhihu.com/p/586535564?utm_campaign=shareopn&utm_medium=social&utm_oi=72254268375040&utm_psn=1580836991456727040&utm_source=wechat_session)。
2. [MySql 三大知识点——索引、锁、事务](https://zhuanlan.zhihu.com/p/59764376)。
3. [全面概述](https://zhuanlan.zhihu.com/p/57451327)。
4. [超经典 50 道 SQL 练习题](https://zhuanlan.zhihu.com/p/40522738)。
5. [类比 excel 与 sql](https://zhuanlan.zhihu.com/p/43284471)。
