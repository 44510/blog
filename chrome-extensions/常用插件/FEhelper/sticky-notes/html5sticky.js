let stickywidth=220,stickyheight=200,max_notes=1e4,allowed_tags="<br /><br><ol></ol><ul></ul><li></li><strong></strong><i></i>",html5sticky={};const STICKYNOTES_ALLKEYS="stickynotes|allkeys",STICKYNOTES_FOLDERS="stickynotes|folders",STICKYNOTES_SELECTED_FOLDER="stickynotes|selected|folder";html5sticky.addNote=function(){if($(".note_common").length===max_notes)return html5sticky.showMessage("#FFE16B","black","当前便签笔记已经足够多了，不能再添加了！"),!1;let t="stickynote_"+1*new Date,e=getDateTime(),o=new Date,i=html5sticky.getColor(),l=html5sticky.getCurrentFolder()[1],n=$('<div class="note_common '+i+'" />').appendTo($("#m_"+l));html5sticky.addPin(n),$(n).append($("<h2>"+e+"</h2>")),$(n).append($("<p></p>")),$(n).append($('<span id="idf_'+t+'" />')),$(".note_common").css({width:stickywidth+"px",height:stickyheight+"px"}),$(".note_common p").css({height:stickyheight-60+"px",width:stickywidth+9+"px"}),$("#removenotes").is(":visible")||$("#removenotes").slideDown("slow"),$("html, body").animate({scrollTop:$(n).offset().top});let s=(localStorage.getItem(STICKYNOTES_ALLKEYS)||"").split(",");s.push(t+"|text"),s.push(t+"|bgcolor"),s.push(t+"|dated"),s.push(t+"|folderid"),localStorage.setItem(STICKYNOTES_ALLKEYS,s.join(",")),localStorage.setItem(t+"|text",$(n).find("h2").text()+"|"+$(n).find("p").text()),localStorage.setItem(t+"|bgcolor",i),localStorage.setItem(t+"|dated",e+"|"+getISODateTime(o)),localStorage.setItem(t+"|folderid",l),html5sticky.enlargeNote(n);let a=$("#f_"+l).find("i");a.text("("+(parseInt(a.text().replace(/\W/,""))+1)+")")},html5sticky.saveNote=function(t){let e=html5sticky.getIdentifier($(t)),o=html5sticky.stripTags($(t).closest(".bignote").find(".hedit")[0].value,allowed_tags),i=html5sticky.stripTags($(t).closest(".bignote").find(".pedit")[0].value,allowed_tags);i=i.replace(/\r?\n/g,"<br />"),localStorage.setItem(e+"|text",o+"|"+i),$("[id^=idf_"+e+"]").closest(".note_common").find("h2").text(o),$("[id^=idf_"+e+"]").closest(".note_common").find("p").html(i),html5sticky.showMessage("#9BED87","black","笔记保存成功！")},html5sticky.getIdentifier=function(t){if(!t)return"stickynote_"+(1*new Date+Math.floor(10*Math.random()));let e=$(t).closest(".bignote").find("[id^=idf_]").attr("id");return void 0!==e&&null!=e||(e=$(t).closest(".note_common").find("[id^=idf_]").attr("id")),void 0!==e&&(e=e.replace("idf_",""))},html5sticky.deleteNote=function(t){if(confirm("确定要删除这个便签笔记吗，一旦删除则不可恢复，请三思?")){let e=html5sticky.getIdentifier($(t));localStorage.removeItem(e),localStorage.removeItem(e+"|text"),localStorage.removeItem(e+"|bgcolor"),localStorage.removeItem(e+"|dated"),localStorage.removeItem(e+"|folderid");let o=(localStorage.getItem(STICKYNOTES_ALLKEYS)||"").split(",");["text","bgcolor","dated","folderid"].forEach(function(t){let i=e+"|"+t;o.indexOf(i)>-1&&o.splice(o.indexOf(i),1)}),localStorage.setItem(STICKYNOTES_ALLKEYS,o.join(",")),$(t).closest(".note_common").fadeOut("slow",function(){$(t).closest(".note_common").remove(),!$(".note_common").length>0&&$("#removenotes").slideUp("slow")})}},html5sticky.deleteAllNotes=function(){confirm("建议删除之前先【全部导出】，否则一旦删除则不可恢复，请三思?")&&$(".note_common").fadeOut("slow",function(){$(".note_common").remove(),(localStorage.getItem(STICKYNOTES_ALLKEYS)||"").split(",").forEach(function(t){localStorage.removeItem(t)}),localStorage.removeItem(STICKYNOTES_ALLKEYS),html5sticky.deleteAllFolders(),location.reload(!0)})},html5sticky.closeNote=function(t){$(t).closest(".bignote")[html5sticky.getAnimation(!0)]("slow",function(){$("#overlay").remove()})},html5sticky.editNote=function(t,e){let o=t.find("p").html();o=o.replace(/(<br \/>|<br>)/g,"\n"),t.find("p").replaceWith('<textarea class="pedit" placeholder="在这里添加笔记" />'),t.find(".pedit").val(o).css({marginTop:"5px",resize:"none",outline:"none"}).addClass("inset").width("568px").height("280px");let i=t.find("h2").text();t.find("h2").replaceWith('<input type="text" class="hedit" />'),$(".hedit").addClass("inset").val(html5sticky.stripTags(i,allowed_tags)).width(250),$('<a href="#" class="close_stickynote"><img src="./img/delete.png" alt="" title="关闭笔记"></a>').css({position:"absolute",top:7,right:5}).appendTo(t),$('<a href="#" class="save_stickynote"><img src="./img/save.png" alt="" title="保存笔记"></a>').css({position:"absolute",top:5,right:50}).appendTo(t)},html5sticky.loadNotes=function(t){let e=$("#m_"+t);if(e[0])return e.removeClass("hide").siblings("div").addClass("hide"),!1;(e=$("<div/>").attr("id","m_"+t).addClass("clearfix").appendTo("#main")).removeClass("hide").siblings("div").addClass("hide");let o=0;(localStorage.getItem(STICKYNOTES_ALLKEYS)||"").split(",").forEach(i=>{if(!/\|text/.test(i))return!1;let l,n,s,a,c,r,d=i.replace("|text","");if(r=localStorage.getItem(d+"|folderid")||"0",String(t)!==r)return!1;n=localStorage.getItem(d+"|bgcolor"),s=(c=localStorage.getItem(d+"|text").split("|"))[0],a=c[1],l=$('<div class="note_common '+n+'" />').appendTo(e),html5sticky.addPin(l),$(l).append($("<h2></h2>")),$(l).append($("<p></p>")),$(l).append($('<span id="idf_'+d+'" />')),$(l).find("h2").text(html5sticky.stripTags(s,allowed_tags)),$(l).find("p").html(html5sticky.stripTags(a,allowed_tags)),$(".note_common").css({width:stickywidth+"px",height:stickyheight+"px"}),$(".note_common p").css({height:stickyheight-60+"px",width:stickywidth-24+"px"}),o++}),$("#f_"+t).find("i").text("("+o+")")},html5sticky.collapse=function(){let t=parseInt($(".note_common:first").find("h2").height()||0,10)+"px";$(".note_common").animate({height:t},function(){$(".note_common").find("p").hide()})},html5sticky.expand=function(){$(".note_common").animate({height:stickyheight},function(){$(".note_common").find("p").fadeIn("slow")})},html5sticky.showMessage=function(t,e,o,i){$("#smsg").is(":visible")||$("html, body").animate({scrollTop:0},500,function(){$("#smsg").length||($('<div id="smsg">'+o+"</div>").appendTo($("body")).css({position:"absolute",top:0,left:0,right:0,height:"40px",lineHeight:"40px",background:t,color:e,zIndex:1e3,fontWeight:"bold",textAlign:"center",opacity:.9,margin:"auto",display:"none"}).slideDown("show"),setTimeout(function(){$("#smsg").animate({width:"hide"},function(){$("#smsg").remove(),i&&i()})},2e3))})},html5sticky.getColor=function(){let t="";return"stickynote"+(t+="0123456789".charAt(Math.floor(Math.random()*"0123456789".length)))},html5sticky.getAnimation=function(t){let e=[];return void 0!==t?(e[1]="hide",e[2]="fadeOut",e[3]="slideUp"):(e[1]="show",e[2]="fadeIn",e[3]="slideDown"),e[Math.ceil(3*Math.random())]},html5sticky.addPin=function(t){let e=$('<div class="btn-close"><a href="#" class="delete_stickynote"><img src="./img/delete.png" width="24" alt="" title="删除笔记"></a></div>'),o=$('<div align="center"><img src="./img/pin.png" alt="" title="关闭"></div>');$(e).css({position:"absolute",top:-15,right:-15}).hide().prependTo($(t)),$(o).css({position:"absolute",zIndex:99,top:-15,left:parseInt(stickywidth/2,10)-10}).prependTo($(t))},html5sticky.enlargeNote=function(t){$this=$(t),$('<div id="overlay" />').css({position:"fixed",background:"rgba(0,0,0,0.5)",top:"0",left:"0",width:"100%",height:"100%",zIndex:"100"}).appendTo($("body")),$clone=$(t).clone().removeClass("note_common").addClass("bignote").appendTo($("#overlay")),$clone.find($('img[src*="pin.png"]').closest("div")).hide(),$clone.find($('img[src*="delete.png"]').closest("div")).hide(),$($clone).css({position:"absolute",zIndex:500,cursor:"default",paddingTop:"5px",width:"600px",height:"376px",top:"50%",left:"50%",display:"none",marginLeft:"-300px",marginTop:"-200px"}),$($clone)[html5sticky.getAnimation()](400);let e="",o="",i=html5sticky.getIdentifier($(t)),l=localStorage.getItem(i+"|dated"),n='<img class="left" align="absmiddle" src="./img/time.png">';e=l.split("|")[0],o=prettyDate(l.split("|")[1]),e=e.length>0?"创建于："+e:"",o=o.length>0?" ("+o+")":"",n=e.length>0?n:"",$('<div class="timeago left" />').prependTo($clone),$(".timeago").css({fontSize:"12px",fontFamily:"tahoma"}).html(n+"&nbsp;&nbsp;"+e+o).after('<div class="clear" />'),$($clone).find(".icons-footer").hide(),html5sticky.editNote($clone,t)},html5sticky.stripTags=function(t,e){e=(((e||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");return t.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi,"").replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(t,o){return e.indexOf("<"+o.toLowerCase()+">")>-1?t:""})},html5sticky.export=function(){chrome.permissions.request({permissions:["downloads"]},t=>{if(t){let t=(localStorage.getItem(STICKYNOTES_ALLKEYS)||"").split(","),e=null;t.length&&(e=new JSZip);let o={};t.forEach(t=>{if(!/\|text/.test(t))return!1;let i,l,n,s,a,c=t.replace("|text","");if(i=localStorage.getItem(c+"|dated"),a=localStorage.getItem(c+"|folderid")||"0",!o[a]){let t=html5sticky.findFolderNameById(a);o[a]=e.folder(t)}l=(s=localStorage.getItem(c+"|text").split("|"))[0],n=s[1],o[a].file(l+".txt",["# title："+l,"# date："+i,"# content：\n"+n].join("\n\n"))}),e&&e.generateAsync({type:"blob"}).then(function(t){chrome.downloads.download({url:URL.createObjectURL(new Blob([t],{type:"application/octet-stream"})),saveAs:!0,conflictAction:"overwrite",filename:"我的便签笔记-"+1*new Date+".zip"})})}else alert("必须接受授权，才能正常下载！")})},html5sticky.importNotes=function(){let t=function(){zip.workerScriptsPath="/static/vendor/jszip/";window.webkitURL||window.mozURL||window.URL;return{getEntries:function(t,e){zip.createReader(new zip.BlobReader(t),function(t){t.getEntries(e)},function(t){console.log(t)})},getEntryFile:function(t,e,o){t.getData(new zip.TextWriter,function(t){e(t)},o)}}}(),e=document.createElement("input");e.type="file",e.accept="application/zip",e.style.cssText="position:absolute;top:-100px;left:-100px",e.addEventListener("change",function(o){t.getEntries(e.files[0],function(e){let o=0,i=e.filter(t=>!t.directory).length;e.forEach(function(e){if(e.directory){o++;let t=e.filename.replace(/\//,"");html5sticky.loadFolders()[t]||html5sticky.saveFolder(t,(new Date).getTime())}else t.getEntryFile(e,function(t){let l=html5sticky.getIdentifier(),n=t.split("# date：")[0].split("# title：")[1].trim(),s=t.split("# date：")[1].split("# content：")[0].trim(),a=t.split("# content：")[1].trim().replace(/\r?\n/g,"<br />"),c=html5sticky.findFolderByName(e.filename.split("/")[0]),r=(localStorage.getItem(STICKYNOTES_ALLKEYS)||"").split(",");r.push(l+"|text"),r.push(l+"|bgcolor"),r.push(l+"|dated"),r.push(l+"|folderid"),localStorage.setItem(STICKYNOTES_ALLKEYS,r.join(",")),localStorage.setItem(l+"|text",n+"|"+a),localStorage.setItem(l+"|bgcolor",html5sticky.getColor()),localStorage.setItem(l+"|dated",s),localStorage.setItem(l+"|folderid",c),++o===i&&html5sticky.showMessage("#9BED87","black","操作成功！共导入"+o+"条笔记！",()=>{location.reload()})})})})},!1),document.body.appendChild(e),e.click()},html5sticky.buildFoldersAndInitNotes=function(){let t=html5sticky.loadFolders();Object.keys(t).forEach((e,o)=>{html5sticky.createFolder(e,t[e]),html5sticky.loadNotes(t[e])});let e=html5sticky.getCurrentFolder();$("li#f_"+e[1]).addClass("x-selected"),html5sticky.loadNotes(e[1])},html5sticky.loadFolders=function(){let t=JSON.parse(localStorage.getItem(STICKYNOTES_FOLDERS)||"{}")||{};return t["默认文件夹"]||(t["默认文件夹"]="0"),t},html5sticky.deleteAllFolders=function(){localStorage.setItem(STICKYNOTES_FOLDERS,"{}"),localStorage.setItem(STICKYNOTES_SELECTED_FOLDER,"[]")},html5sticky.saveFolder=function(t,e){let o=html5sticky.loadFolders();o[t]=e,localStorage.setItem(STICKYNOTES_FOLDERS,JSON.stringify(o))},html5sticky.createFolder=function(t,e){if(t=t||window.prompt("新建文件夹")){if(!e){if(html5sticky.loadFolders()[t])return alert("你已经创建过这个文件夹！")}return e=e||(new Date).getTime(),html5sticky.saveFolder(t,e),$("<li><span></span><i>(0)</i></li>").find("span").text(t).end().attr("id","f_"+e).appendTo("#folders")}if(null!==t)return alert("文件夹名不能为空！")},html5sticky.getCurrentFolder=function(){let t=JSON.parse(localStorage.getItem(STICKYNOTES_SELECTED_FOLDER)||"[]")||[];return t.length||(t=["默认文件夹","0"]),t},html5sticky.setCurrentFolder=function(t,e){localStorage.setItem(STICKYNOTES_SELECTED_FOLDER,JSON.stringify([t,e]))},html5sticky.findFolderNameById=function(t){let e=html5sticky.loadFolders(),o=Object.keys(e).filter(o=>String(e[o])===String(t));return o.length?o[0]:"默认文件夹"},html5sticky.findFolderByName=function(t){let e=JSON.parse(localStorage.getItem(STICKYNOTES_FOLDERS)||"{}")||{};return e["默认文件夹"]||(e["默认文件夹"]="0"),e[t]};