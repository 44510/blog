## 2.1.自定义插件步骤

## 自定义webpack的插件

1. 插件开发的原理
2. 几个主要的对象；
3. 开发基础的示例
   1. 前中后各个阶段的代码处理；

插件 是 webpack 的 支柱 功能。Webpack 自身也是构建于你在 webpack 配置中用到的 相同的插件系统 之上！

插件目的在于解决 loader 无法实现的其他事。Webpack 提供很多开箱即用的 插件。

**开发插件时最重要的两个概念是 compiler 编译器和 compilation 编译对象**。理解它们的角色是扩展 webpack 引擎重要的第一步。

一旦我们可以深入理解 webpack compiler 和每个独立的 compilation，我们依赖 webpack 引擎**将有无限多的事可以做**。我们可以重新格式化已有的文件，创建衍生的文件，或者制作全新的生成文件。

### 插件的不同类型

1. webpack 插件可以**按照它所注册的事件分成不同的类型**。每一个事件钩子都预先定义为同步、异步、瀑布或并行钩子，钩子在内部用 call/callAsync 方法调用。支持的钩子清单或可被绑定的钩子清单，通常在 this.hooks 属性指定。

### 插件的生命周期

Webpack 的插件的生命周期是指 Webpack 在执行其构建任务时，对插件的调用和处理过程。
下面是 Webpack 插件的生命周期的详细介绍：

1. 加载阶段（ load ）：在 Webpack 开始解析项目的时候，会加载所有的插件。在这个阶段，**插件可以获取到 Webpack 的配置信息**，并进行一些初始化工作。
2. 分析阶段（ analyze ）：在 Webpack 分析项目依赖关系的时候，会调用每个插件的 apply 方法。在这个阶段，插件可以对项目进行进一步的分析和处理，例如处理 require 语句、添加新的 loader 等。
3. **编译阶段**（ compile ）：在 Webpack 开始编译项目的时候，会再次调用每个插件的 apply 方法。在这个阶段，插件可以对项目进行进一步的处理，**例如代码压缩、文件优化等**。
4. 生成阶段（ generate ）：在 Webpack 生成最终的输出文件的时候，会最后一次调用每个插件的 apply 方法。在这个阶段，插件可以对生成的文件进行进一步的处理，**例如添加版本号、改变文件名等**。
5. **结束阶段（ done ）**：在 Webpack 完成所有的构建任务之后，会调用每个插件的 done 方法。在这个阶段，插件可以进行一些清理工作，例如释放内存等。

通过了解 Webpack 插件的生命周期，你可以更好地理解 Webpack 插件的工作原理，并根据需要编写自己的插件。同时，也可以更好地使用现有的插件，根据项目的需要进行配置和使用。

这里的apply方法会被调用3次？

### 创建插件

webpack 插件由以下组成：

1. 一个 JavaScript 命名函数或 JavaScript 类。
2. 在插件函数的 prototype 上**定义一个 apply 方法**。
   1. **这个 apply 方法在安装插件时，会被 webpack compiler 调用一次**。
   2. apply 方法可以接收一个 webpack compiler 对象的引用，**从而可以在回调函数中访问到 compiler 对象**。
3. **指定一个绑定到 webpack 自身的事件钩子**。
4. **处理 webpack 内部实例的特定数据**。
   1. 特定数据？
5. 功能完成后调用 webpack 提供的回调。
   1. 执行回调，类似next()，返回结果，继续后续的操作

### 以下是一些常见的 Webpack 生命周期钩子

1. beforeRun：在运行 webpack 的命令之前执行；
2. run：在启动 webpack 运行时执行；
3. compile：在开始编译模块之前执行；
4. compilation：在创建新的 compilation 实例时执行；
5. emit：**在生成最终版本的资源之前执行**；
   1. 这个时候代码是经历过合并的；
6. done：在编译完成后执行。

### 在开发插件时，你可能会不知道该如何下手，因为你不知道该监听哪个事件才能完成任务

在开发插件时，还需要注意以下两点：

1. 只要能拿到 Compiler 或 Compilation 对象，就能广播出新的事件，所以在新开发的插件中也能广播出事件，给其它插件监听使用。
2. 传给每个插件的 Compiler 和 Compilation 对象都是同一个引用。也就是说在一个插件中修改了 Compiler 或 Compilation 对象上的属性，会影响到后面的插件。
3. 有些事件是异步的，这些异步的事件会附带两个参数，第二个参数为回调函数，在插件处理完任务时需要调用回调函数通知 Webpack，才会进入下一处理流程。
   1. 这里的事件主要有三种类型：tap，tapSync，tapPromise；

### webpack 插件开发

[参考文档](https://www.webpackjs.com/contribute/writing-a-plugin/)

插件向第三方开发者提供了 webpack 引擎中完整的能力。使用阶段式的构建回调，开发者可以引入它们自己的行为到 webpack 构建流程中。创建插件比创建 loader 更加高级，因为你将需要理解一些 webpack 底层的内部特性来做相应的钩子，所以做好阅读一些源码的准备！

webpack 插件由以下组成：

- 一个 JavaScript 命名函数（构造函数）。
- 在插件函数的 prototype 上定义一个 apply 方法（入口，拿到参数 compiler）。
  - 这个 apply 方法在安装插件时，会被 webpack compiler 调用一次。
- 指定一个绑定到 webpack 自身的事件钩子（webpack 的执行阶段，如 AssetsReplacePlugin）。
- 处理 webpack 内部实例的特定数据。
  - 如：compilation.assets
- 功能完成后调用 webpack 提供的回调。
  - 如：.source()
