---
title: JS的内存机制
date: 2018-6-6
tags:
  - JS内存管理
  - JS的内存机制
  - 堆内存
  - 栈内存
categories:
  - [JS, JS的内存机制]
---

[TOC]

## 栈内存和堆内存，JS内存空间分为栈(stack)、堆(heap)、池(一般也会归类为栈中)

JavaScript 内存空间分为**栈，堆，池，队列**。

1. 其中栈存放变量，基本类型数据与指向复杂类型数据的引用指针；
   1. null会被存储在栈中，通常用来进行释放一个变量；
2. 堆存放复杂类型数据；
3. 池又称为常量池，用于存放常量(一般也会归类为栈中)；
   1. 其中栈存放变量，堆存放复杂对象，池存放常量。
4. 而队列在任务队列也会使用。

- 堆（heap），堆是堆内存的简称。
- 栈（stack），栈是栈内存的简称。

说到堆栈，我们讲的就是内存的使用和分配了，没有寄存器的事，也没有硬盘的事。

栈，线性结构，后进先出，便于管理。

堆，一个混沌，杂乱无章，方便存储和开辟内存空间。

我们首先记住一句话：JS 中，所有的**变量**都是保存在**栈内存**中的。

### 堆内存

堆是动态分配内存，内存大小不一，也不会自动释放。

- JS 中其他类型的数据被称为**引用类型的数据**（如**对象、数组、函数**等），它们是通过拷贝和 new 出来的，这样的数据存储于堆中。
- **引用类型的数据的地址指针是存储于栈中的**，当我们想要访问引用类型的值的时候，需要**先从栈中获得对象的地址指针，然后，在通过地址指针找到堆中的所需要的数据**。

### 栈内存

栈是自动分配相对固定大小的内存空间，并由系统自动释放。

JS 的基本类型就 5 种，Undefined、Null、不是 new 出来的布尔、数字和字符串，它们**都是直接按值存储在栈中的**，每种类型的数据占用的内存空间的大小是确定的，并由系统**自动分配和自动释放**。这样带来的好处就是，内存可以及时得到回收，相对于堆来说，更加容易管理内存空间。

然后来看看下面的区别。

### 基本数据类型

**基本数据类型的值，直接保存在栈内存中**。值与值之间是独立存在，修改一个变量不会影响其他的变量。

### 引用数据类型

**对象是保存到堆内存中的**。每创建一个新的对象，就会在堆内存中开辟出一个新的空间，而**变量保存了对象的内存地址**（对象的引用）。如果两个变量保存了同一个对象的引用，当一个通过一个变量修改属性时，另一个也会受到影响。

## 堆和栈的区别 | 栈和堆具体怎么存储

栈内存中的变量一般都是**已知大小或者有范围上限的**，算作一种简单存储。

而堆内存存储的**对象类型数据对于大小这方面，一般都是未知的**。个人认为，**这也是为什么 null 作为一个 object 类型的变量却存储在栈内存中的原因**。

一般来说栈内存线性有序存储，容量小，系统分配效率高。

而堆内存首先要在堆内存新分配存储区域，之后又要把指针存储到栈内存中，效率相对就要低一些了。

## 垃圾回收时栈和堆的区别

1. 垃圾回收方面，**栈内存变量基本上用完就回收了**，而堆内存中的变量因为存在很多不确定的引用，只有**当所有调用的变量全部销毁之后才能回收**。
2. 在JavaScript中，**最常用的是通过标记清除的算法来找到哪些对象是不再继续使用的，因此 a = null 其实仅仅只是做了一个释放引用的操作**，让 a 原本对应的值失去引用，脱离执行环境，这个值会在下一次垃圾收集器执行操作时被找到并释放。而在适当的时候解除引用，是为页面获得更好性能的一个重要方式。
3. 全局对象，通常不会被垃圾回收，所以尽量避免创建全局变量；
4. 局部变量在不使用的时候会被回收，但是类似闭包这样的，会保留引用；

## object 与 array 的存储方式及访问效率

1. JS 的数组和 C 语言的数组是不一样的。**C 的数组是连续内存存储**，通过指针或这下标可以直接定位数组中的元素。而 JS 的实现要复杂一些。
2. JS 中，数组的内部实现有点不一样，如果数组**使用的过程中**，
   1. 所百有的元素都是**同样的结构**，那么会尽可能按照 C 语言的方法去实现，
   2. 但是一点添加一个异类的元素，JS 解释器会**立刻重构这个数组，采用哈希表**。
      1. 这的数组如果元素的类型不同，会使用hash表存储，表现的和一般对象类似；
3. 你可以认为**大多数情况下，都是用哈希表的**。
   1. **哈希表不光要算哈希值，而且如果数组特别大的情况，还要有复杂度为 O(n)的链表遍历**，很亏；
   2. 最后，JS 的数组的索引看起来是个数字，**但是实际上在实现的时候，会被内道部转换为字符串**。

## 内存的生命周期

1. 内存分配：当我们申明变量、函数、对象的时候，系统会自动为他 们分配内存；
   1. 赋值属于内存分配的过程；
2. 内存使用：即读写内存，也就是使用变量、函数等；
   1. 操作；
3. 内存回收：使用完毕，由垃圾回收机制**自动回收不再使用的内存**。

## 数组与对象的遍历方法比较

## 参考文章

[JavaScript 内存机制](https://www.cnblogs.com/liangyin/p/7764232.html)
