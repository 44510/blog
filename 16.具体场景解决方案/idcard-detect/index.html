<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <meta name="screen-orientation" content="portrait" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="full-screen" content="yes" />
    <meta name="x5-fullscreen" content="true" />
    <script src="./js/set-rem.js"></script>
    <script src="./js/help.js"></script>
    <script src="./js/jquery-2.0.3.min.js"></script>
    <title>检测</title>
    <style>
      * {
        padding: 0;
        margin: 0;
        font-size: 0.16rem;
        font-family: 'PingFangSC-Regular';
        color: #4c4c4c;
        box-sizing: border-box;
      }

      .page {
        padding: 0.25rem;
      }
      .img-upload {
        position: relative;
        width: 100%;
        overflow: hidden;
        margin: 0.2rem 0;
      }

      .img-upload input {
        display: none;
      }
      .img-upload label {
        position: relative;
        width: 3.25rem;
      }
      .img-upload label > div {
      }

      .img-upload label .preview {
      }

      .img-upload label .btn-add {
        position: absolute;
        z-index: 100;
        left: 1.22rem;
        top: 0.5rem;
      }
      .img-upload label .btn-add img {
        width: 1rem;
        height: 1rem;
        display: none;
      }

      .img-upload .preview img {
        width: 3.25rem;
        max-height: 3.5rem;
      }

      .detect-result .row {
        height: 0.4rem;
      }

      .detect-result .row label {
        display: inline-flex;
        width: 0.7rem;
      }
      .detect-result .row input {
        text-indent: 5px;
      }

      #submit {
        background-image: linear-gradient(163deg, #60b1fe 0%, #6551f6 100%);
        border-radius: 0.34rem;
        display: block;
        width: 3.25rem;
        height: 0.44rem;
        line-height: 0.44rem;
        color: #fff;
        font-size: 0.16rem;
        margin-top: 0.2rem;
      }

      .loading {
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        height: 100vh;
        width: 100vw;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 0, 0.3);
        display: none;
      }
      .loading img {
        width: 100px;
      }
    </style>
    <script>
      $(document).ready(function () {
        var page = {
          init() {
            this.addEventListener();
          },
          config: {
            baseUrl: 'http://112.74.95.13:8088',
          },
          params: {
            frontPicture: '',
            backPicture: '',
            avatar: '',
            name: '',
            cardNo: '',
          },

          loading: {
            show() {
              $('.loading').css('display', 'flex');
            },
            hide() {
              $('.loading').css('display', 'none');
            },
          },

          addEventListener() {
            var that = this;
            // 绑定一系列的事件
            $('.item input').change(function (e) {
              var key = $(e.currentTarget).attr('id');
              // $(this).siblings('.btn-add').hide();

              that.getImgBase64AndSetPreview(e, key).then(function () {
                var { frontPicture, backPicture } = that.params;
                if (('frontPicture' === key || 'backPicture' === key) && frontPicture && backPicture) {
                  // 这个时候刷新ocr认证
                  that.ocrCheck();
                }
              });
            });

            $('#submit').click(function (e) {
              that.rpCheck();
            });
          },

          ajaxGetData(path, data) {
            let that = this;
            that.loading.show();
            // 这里返回的是一个promise
            return $.ajax({
              type: 'post',
              url: that.config.baseUrl + path,
              data: JSON.stringify(data),
              contentType: 'application/json',
              success: function (result) {
                console.log('success:', result);
                that.loading.hide();
                if (result.code !== 200) {
                  alert(result.msg);
                }
              },
            });
          },

          ocrCheck() {
            let that = this;
            var { frontPicture, backPicture } = that.params;
            var result = that.ajaxGetData('/idcard/ocr/check', {
              frontPicture,
              backPicture,
            });
            result.then(function (response) {
              if (response.code === 200) {
                var data = response.data;
                var { ocrName, ocrCardNo } = data || {};
                that.params.name = ocrName;
                that.params.cardNo = ocrCardNo;

                $('#name').val(ocrName);
                $('#cardNo').val(ocrCardNo);
              }
            });
          },

          rpCheck() {
            let that = this;
            var { name, cardNo, avatar } = that.params;

            var result = that.ajaxGetData('/idcard/rp/check', {
              name,
              cardNo,
              avatar,
            });

            result.then(function (response) {
              if (response.code === 200) {
                location.href = './result.html';
              }
            });
          },
          // 获取图片的base64，并且设置预览图片，且设置参数到当前的对象上，方便后边调用
          getImgBase64AndSetPreview(e, key) {
            var that = this;
            return new Promise(function (resolve, reject) {
              const resultFile = e.target.files; // input 获取的文件列表
              // console.log(`resultFile`, resultFile)
              const aBlob = new Blob([resultFile[0]], { type: 'image/jpeg' }); // 指定转换成blob的类型
              // console.log(`aBlob`, aBlob)
              const reader = new FileReader(); // 3 新建 FileReader 对象,用于操作文件
              // console.log(`reader`, reader)
              reader.onload = (ev) => {
                let base64Url = ev.target.result; // 5 base64内容
                $('#' + key + ' + label .preview img').attr('src', base64Url);
                compress(base64Url, 1.5, function (base64) {
                  that.params[key] = base64.split('base64,')[1];
                  // $('#' + key + ' + label .btn-add').hide();
                  resolve();
                });
              };
              reader.readAsDataURL(aBlob); // 4 将文件转换成指定类型的数据
            });
          },
        };

        page.init();
      });
    </script>
  </head>
  <body>
    <div class="loading">
      <img src="./img/loading.gif" alt="" />
    </div>
    <div class="page">
      <div class="form">
        <div class="item">
          <h3>身份证人像页面</h3>
          <div class="img-upload">
            <input type="file" id="frontPicture" class="idCard" accept="image/*" capture="camera" />

            <label for="frontPicture">
              <div class="preview">
                <img src="./img/idCard-rx@3x.png" alt="" srcset="" />
              </div>
              <div class="btn-add">
                <img src="./img/add@3x.png" alt="" srcset="" />
              </div>
            </label>
          </div>
        </div>
        <div class="item">
          <h3>身份证国徽页面</h3>
          <div class="img-upload">
            <input type="file" id="backPicture" class="idCard" accept="image/*" capture="camera" />

            <label for="backPicture">
              <div class="preview">
                <img src="./img/idCard-gh@3x.png" alt="" srcset="" />
              </div>
              <div class="btn-add">
                <img src="./img/add@3x.png" alt="" srcset="" />
              </div>
            </label>
          </div>
        </div>

        <div class="item">
          <h3>自拍照片</h3>
          <div class="img-upload">
            <input type="file" id="avatar" class="idCard" accept="image/*" capture="camera" />

            <label for="avatar">
              <div class="preview">
                <img src="./img/idCard-sc@3x.png" alt="" srcset="" />
              </div>
              <div class="btn-add">
                <img src="./img/add@3x.png" alt="" srcset="" />
              </div>
            </label>
          </div>
        </div>
      </div>

      <div class="detect-result">
        <div class="row">
          <label for="name">姓名:</label>
          <input type="text" id="name" disabled />
        </div>
        <div class="row">
          <label for="cardNo">身份证号:</label>
          <input type="text" id="cardNo" disabled />
        </div>
      </div>

      <div class="btn">
        <button type="submit" id="submit">检测</button>
      </div>
    </div>
  </body>
</html>
