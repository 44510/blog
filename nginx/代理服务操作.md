# 代理服务操作

## apache

[参考文档](https://www.jianshu.com/p/24cda13b51a4)

开启 apache: sudo apachectl start

重启 apache: sudo apachectl restart

关闭 apache: sudo apachectl stop

默认占用 80 端口，所以开启之后，可以直接访问`localhost`，可查看服务启动成功；

## nginx

1. brew install nginx

2. 修改配置文件，端口设置为 80，/usr/local/etc/nginx/nginx.conf

3. 通过 nginx -V，可以查看详细信息；

4. 添加权限；

sudo chown root:wheel /usr/local/Cellar/nginx/1.17.9/bin/nginx
sudo chmod u+s /usr/local/Cellar/nginx/1.17.9/bin/nginx
sudo chown -R root:wheel /usr/local/etc/nginx/

5. 这里的版本号要根据自己的做修改，用 brew info nginx 来查看路径

### 开启和关闭命令

1. brew services start nginx
2. nginx
3. nginx -t
4. nginx -s reload
5. sudo nginx -s reload // 重载配置文件
6. sudo nginx -s stop // 停止 nginx 服务
7. sudo nginx // 开启 nginx 服务

### 设置反向代理

目标是：代理`http://apigw.qa.91jkys.com/api/activity/1.0/save_user_info`

代理到

### nginx 请求转发

1. [参考文章](https://www.jianshu.com/p/66d3957c6698)

原路径： http://source.server.com/callback/test/test?username=xx

转发到：http://10.1.9.1:8088/callback/test/test?username=xx

配置如下：

server {
   listen      80;
   server_name ;
  # 匹配 callback
   location /callback/ {
       proxy_pass http://10.1.9.1:8088;
   }

# 默认其他

location / {
     proxy_pass http://10.2.2.1:8088;
     # root  html;
     # index  index.html index.htm;
   }
}

```conf
# 配置接口转发
server {
    listen   1024;
    server_name  apigw.qa.91jkys.com;
    location /api/ {
        proxy_pass http://apigw.qa.91jkys.com:80
    }
}
```

## 同一个端口不能被多次监听

如不能同时被 nginx 和 node 监听；

似乎 charles 是一个不错的选择。

**可以的**

```
<!-- 这里表示，hy.qa.91jkys.com:80的请求被代理到了，http://localhost:9001，所以服务需要启动在9001， --port 9001 -->
server{
  index       index.html;
  listen 80;
  server_name     hy.qa.91jkys.com;
  location / {
      proxy_pass      http://localhost:9001;
      index                    index.js index.html index.htm;
      proxy_buffer_size        128k;
      proxy_buffers            64 64k;
      proxy_busy_buffers_size  256k;
      proxy_set_header         Host $host;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header http_x_forwarded_for $proxy_add_x_forwarded_for;
  }
}
```
