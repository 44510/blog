---
title: JS垃圾回收及JS内存泄露
date: 2018-3-6
tags:
  - JS
  - JS垃圾回收
  - JS内存泄露
categories:
  - [JS, JS垃圾回收]
  - [JS, JS内存泄露]
top: 5
---

[TOC]

## 垃圾回收机制

程序的运行需要**内存**。只要程序提出要求，操作系统或者运行时就必须供给内存。所谓的**内存泄漏**简单来说是**不再用到的内存，没有及时释放**。

在 Java、C#、JavaScript 语言中，变量的内存空间的申请和释放都由程序自己处理，开发人员不需要关心。也就是说**Javascript 具有自动垃圾回收机制(Garbage Collecation)**。

### 垃圾回收

1. 在 js 中，垃圾回收器**每隔一段时间就会找出那些不再使用的数据**，并释放其所占用的内存空间。

2. 以全局变量和局部变量来说，
   1. 函数中的**局部变量**在函数执行结束后这些变量已经不再被需要，所以垃圾回收器会识别并释放它们。
   2. 而对于**全局变量**，**垃圾回收器很难判断这些变量什么时候才不被需要**，所以尽量少使用全局变量。

### 垃圾回收原理

1. JavaScript 会自动**分配内存**，并在不再使用时**自动释放内存**。
2. JavaScript 垃圾回收的机制很简单：**找出不再使用的变量，然后释放掉其占用的内存**，
3. 但是这个过程不是实时的，因为其开销比较大，所以垃圾回收器会**按照固定的时间间隔周期性的执行**。

### 垃圾回收有两种方法

1. **标记清除**<删除环境中的**已经无法访问到的变量**>
2. **引用计数<引用数为 0 就需要释放内存>**。引用计数不太常用，**标记清除较为常用**。

## 哪些情况会引起内存泄漏

内存泄露是指一块被分配的内存**既不能使用，又不能回收**，直到浏览器进程结束。

过多的占用内存，可能会导致运行 js 的网页**耗尽全部系统内存而导致系统崩溃**。

### 四种常见的 JavaScript 内存泄漏，应该尽量避免

1. **全局变量**：注意不要让本来要定义的局部变量成为一个全局变量。
   1. **解决之道**：你可以通过在 JavaScript 文件的**开始处添加‘use strict’**;来避免这中错误，这种方式将开启严格的解析 JavaScript 模式，从而**防止意外创建全局变量**。
2. 被遗忘的**定时器或者回调**；
3. **闭包**，闭包是一个内部函数，可以访问外部（封闭）函数的变量；
   1. **解决之道**：将事件处理函数定义在外部，
   2. **解除闭包**，或者在定义事件处理函数的外部函数中，**删除对 dom 的引用**。
4. **没有清理的 DOM 元素引用**；
5. **自动类型装箱转换**。

```js
var s = 'lalala';
alert(s.length);
// s本身是一个string而非object，它没有length属性，所以当访问length时，JS引擎会自动创建一个临时String对象封装s，而这个对象一定会泄露。

// 这个bug匪夷所思，所幸解决起来相当容易，记得所有值类型做.运算之前先显式转换一下：
var s = 'lalala';
alert(new String(s).length);
```

### 日常如何避免内存泄漏

不用了的东西要及时归还。

1. 引用类型，不使用的变量需要置为 **null**；
2. 复用声明，**避免循环过程中重复创建**；

将变量设置为 null(解除引用)，意味着切断变量与此前引用的值之间的链接。当垃圾回收器下次运行的时候就会删除这些值，并回收他们占用的内存。

### 内存泄漏的识别方法 ｜ 查看方法 ｜ 使用 chrome 查看内存运行状况

步骤:

1. 打开开发者工具 Performance
2. 勾选 Screenshots 和 memory
3. 左上角小圆点开始录制(record)
4. 停止录制

图中 **Heap** 对应的部分就可以看到内存在周期性的回落也可以看到垃圾回收的周期,如果垃圾回收之后的最低值(我们称为 min),min 在不断上涨,那么肯定是有较为严重的内存泄漏问题。

## 参考文章

[JavaScript 中的垃圾回收和内存泄漏](https://juejin.im/post/5cb33660e51d456e811d2687)

[JS 从内存空间谈到垃圾回收机制](https://www.cnblogs.com/echolun/p/11503915.html)
